# HeMem

## 内存访问追踪

为了有效地将数据放置在 DRAM 和 NVM 中，HeMem 需要一种有效的机制来观察正在访问哪些内存以及访问频率

* 异步内存访问采样

  处理器在性能计数器（performance counter）溢出后将记录写入预分配的内存缓冲区

  让PEBS 从 NVM (MEM_LOAD_RETIRED.LOCAL_PMM) 、 DRAM (MEM_LOAD_L3_MISS_RETIRED.LOCAL_DRAM) 提供的所有负载以及所有存储 (MEM_INST_RETIRED.ALL_STORES) 进行采样，记录采样的指令的目标虚拟内存地址

  使用该地址来确定哪些内存区域被频繁访问

  ——这是确定样本

* 数据分类

  PEBS跟踪指令访问的目标虚拟内存地址（上述采样步骤记录的指令，即样本），通常以页为粒度

  记录样本的读写次数，

  将数据分类为热数据或冷数据

随着时间的推移，某些数据可能不再频繁访问，而其他数据可能开始被频繁访问。如果不进行冷却，即使该页面不再频繁访问，页面的访问计数可能会累积到一个很高的值，导致 HeMem 将不再热门的页面错误地识别为热数据

设定采样访问阈值（18），一旦任何页面超过阈值，所有页面的访问计数减半，再判断是冷数据/热数据

避免在将所有页面访问次数减半时遍历：

一旦任何页面达到冷却阈值，增加时钟。下次对页面进行采样时，如果上次冷却页面的时间与当前时钟不匹配，则在递增页面的访问计数之前冷却该页面

## 库机制（内存分配、放置、迁移和页面错误）

* 分配

  在进程启动时将每个进程的DAX文件映射到虚拟内存中，以进行异步迁移。在mmap时，HeMem根据其策略分配内存区域

* 数据迁移

  在单独的后台进程中10ms执行一次（决定将数据迁移到DRAM还是NVM）

  使用userfaultfd将页面标记为写保护（这允许在迁移过程中继续读取页面，但对页面的任何写入都必须等到迁移完成）

  迁移完成后，页面访问权限将恢复

  * 将数据迁移卸载到I/OAT DMA

    通过ioctl调用DMA数据复制接口，使用额外的ioctl调用进行DMA通道分配

* 缺页处理

  使用userfaultfd

## 策略（内存分配和迁移）

* 内存分配和放置

  **优先从DRAM中分配**：如果DRAM中有可用的空闲页面，HeMem会从free list中移除一个页面并分配给应用程序

  当DRAM用完时，从NVM中分配，当NVM中的数据变热时，迁移到DRAM中

  保持一定量的DRAM（1G）空闲，当周期执行的后台进程注意到DRAM达到此阈值，强制数据迁移到NVM

  **小内存分配**：截获mmap时，获取要分配的内存大小。处理小内存时，将调用转发给内核（即保留在DRAM中）；跟踪内存区域的小分配增长，一旦超过阈值（1G），将其交给HeMem管理

* 内存迁移

  

